# A reproducible LFS build
Building your own Linux distribution from scratch is a lot of fun. It's also a pain in the ass when you mess up compiling some tool and need to start over from scratch, as each rebuild is another opportunity to make a new error, requiring you to repeat your Sysyphean task of debugging and rebuilding.

Inspired by [this series](https://www.youtube.com/watch?v=IXA0GNTLf_Q), I've written shell scripts that automate this process for me. Please note that I've only tested these scripts on my own setup (running Ubuntu Desktop 22.04-LTS from a bootable USB on a custom-built PC with an x86\_64 processor and an M.2 SSD with about 2TB of storage). To run these scripts on a different setup, you'll need to adjust them to fit your system.

Additionally, because LFS is meant to be customizable, there are a lot of decision points where I made a choice based on my own needs/goals. You may wish to make a different decision, so I'd highly recommend working with the [LFS book](https://www.linuxfromscratch.org/lfs/view/stable/index.html) to figure out where you would like to choose an alternative route and change the scripts accordingly.

In fact, you will probably be better off using this repository as a _guide_ for creating your own automated LFS scripts rather than running it and waiting for it to give you an error. You may also wish to incorporate some of the packages included in Beyond Linux From Scratch into your build. In my experience, installing enough BLFS packages while still in the chroot environment on the host system is much easier than booting up your LFS build and wondering how to download packages without `wget`.

## Setup
Because I'm building on a bootable USB, every time I power off the computer, I have to set up Ubuntu anew, which means reinstalling any packages needed to complete the rest of the build. This repository includes a script (`install-development-packages.sh`) to do just that. It also includes some packages used only for developing this repo, such as `vim` and the GitHub CLI. I'd recommend installing all of the packages (although you can adjust your `~/.vimrc` file to fit your preferences) so that you can make your own repo to reflect your customizations. To that end, you should set up your build environment with the following steps:
  1. Obtain a USB stick with adequate storage. I bought a 32GB Sandisk, but you can probably make do with less, as Alpine has a pretty small profile, and you'll be installing packages into RAM.
  2. Download your image from [Ubuntu's website](https://ubuntu.com/download/desktop).
  3. Burn the ISO to the USB. For Ubuntu, see [these instructions](https://ubuntu.com/tutorials/install-ubuntu-desktop#3-create-a-bootable-usb-stick).
  4. Boot the USB on the computer you plan to use for building LFS. You may need to enter the BIOS settings to allow your PC to boot from the USB. Ubuntu's installation instructions provide more details [here](https://ubuntu.com/tutorials/install-ubuntu-desktop#4-boot-from-usb-flash-drive).
  5. Choose "Try Ubuntu" on the welcome screen that appears after booting, then open a terminal.
  6. Install git with `sudo apt update && sudo apt install -y git` (or the equivalent for your distribution. Configure git with your name and email (`git configure --global user.name "<Your Name" && git configure --global user.email "<Your Email>"`).
  7. Clone this repository with `git clone https://github.com/ethanscorey/lfs.git` (replacing the URL with the URL to your repository if you followed the suggestion above to create your own fork of the repo). Then, change into the newly created directory with `cd lfs`. You may also want to log in to the GitHub CLI so that you can push changes to the scripts to your forked repo. If so, add your username and personal access token to the repo URL: `git clone <username>:<auth_token>@github.com/<username>/lfs.git`.
  8. Run `./create-lfs-user.sh lfs` to create a dedicated user for the buildand then `cd lfs` to navigate to the LFS working directory. Then run `./setup.sh <PATH_TO_LFS_DISK> <PASSWORD_FOR_LFS_USER>`, and make sure all of the necessary packages are installed. See the [LFS book](https://www.linuxfromscratch.org/lfs/view/stable/chapter02/hostreqs.html) for more details. **If you are building for a system with a non-x86_64 processor, edit the line `export LFS_TGT=x86_64-lfs-linux-gnu` before running this script. If you ran it without making this change, run it again.** You may delete `packages.csv`, `wget-list-sysv`, and `md5sums` if you want to use the most up-to-date version of the package list from the LFS book.

At this point, you should be logged in as the `lfs` user (confirm that you see `lfs` in your bash prompt), and the target system should be mounted. You can confirm this by runnnning `sudo fdisk -l`. You should also confirm that `$LFS` and `$LFS_TGT` have been set to the correct values by running `echo $LFS $LFS_TGT`. 

## Building the Cross-Compilation Toolchain
First, run `./compile-cross-toolchain.sh` as the user `lfs`. You can check the logs for errors by running `grep -R "Error|error:" logs/chapter5`. Then, run `/lfs/compile-temporary-tools.sh` as the user `lfs`, and check for errors with `grep -R "Error|error:" logs/chapter6.

## Building the System
Next, we set up the `chroot` environment by running `sudo ./setup-chroot $LFS`. This will install all packages in the LFS book up to the end of Chapter 7. Then, run `./backup-system.sh` to create a backup of the environment. This will save you from having to repeat chapters 1-7 in the event that any of the packages in Chapter 8 are installed incorrectly. I highly recommend saving the backup in cloud storage or on a separate external storage device.

Then, we compile all of the core system software by running `./run-in-chroot.sh $LFS chapter8/install-packages.sh`. This step will take a **long** time to run. Go run some errands or watch a movie or climb a mountain or something like that. Once it's finished, you should compare the build logs with those posted on the LFS book website. There will almost certainly be some errors and test failures, but most of them can be safely ignored. Once it's finished, make sure to check the logs for errors/test failures. Some test failures are expected, so compare your results with the build logs on the LFS site to check whether your logs look similar. Then, clean up from the installation process by running `./run-in-chroot.sh $LFS installation-cleanup.sh`. **Make sure you do not run `installation-cleanup.sh` outside of the chroot environment, or your host system may be unusable.**

## Configuring the System and Making it Bootable
Run `./run-in-chroot.sh $LFS system-config.sh` to configure your system. Then, run `./run-in-chroot.sh $LFS make-bootable.sh <PATH_TO_LFS_DISK>`. This will bring up the menu for kernel configuration, at which point you'll need to follow the instructions in LFS/BLFS to find the correct configuration options. Once you exit the menu and save your results, the script will continue with kernel compilation.

## Building in Stages
LFS is meant to be built in one session, but if you have to reboot the system, make sure to follow steps 4-8 in the setup instructions above. If you have already compiled packages and don't want to recompile them, you can comment out the relevant installation script by running `sed -e "s/^/#/" <chapternumber>/<package>.sh`.
